name: CoinFx Bot Docker 🚀 (Self-fixing)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 🛠 Checkout Code
      uses: actions/checkout@v4

    - name: 🐋 Setup Docker
      uses: docker/setup-buildx-action@v3

    - name: 🔄 Auto-fix Dependencies & Update `requirements.txt`
      run: |
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install numpy scipy tensorflow keras scikit-learn pandas websocket-client grpcio protobuf python-dotenv || {
          echo "⚠️ Conflict detected! Fixing dependencies..."
          pip uninstall -y cbpro requests six
          pip install requests>=2.21.0 six>=1.12.0 tensorflow keras numpy scipy scikit-learn pandas websocket-client grpcio protobuf python-dotenv
          pip install --no-cache-dir git+https://github.com/danpaquin/coinbasepro-python.git
        }
        pip freeze > requirements.txt
        deactivate

    - name: 🛠 Build Docker Image
      run: docker build --no-cache -t coinfx-trading-bot:latest .

    - name: 🧪 Run Docker Sanity Check
      run: docker run --rm coinfx-trading-bot:latest python -c "print('✅ Docker Sanity Check Passed')"

    - name: 🚀 Create `fxcbot` Executable
      run: |
        echo '#!/bin/bash' | sudo tee /usr/local/bin/fxcbot
        echo 'docker run --rm -it --name coinfx-trading-bot coinfx-trading-bot "$@"' | sudo tee -a /usr/local/bin/fxcbot
        sudo chmod +x /usr/local/bin/fxcbot

    - name: 📤 Upload `fxcbot` Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fxcbot-linux
        path: /usr/local/bin/fxcbot
