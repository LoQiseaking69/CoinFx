name: CoinFx Bot Docker 🚀 (Self-fixing & Deployment)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 🛠 Checkout Code
      uses: actions/checkout@v4

    - name: 🐋 Setup Docker
      uses: docker/setup-buildx-action@v3

    - name: 🔄 Auto-fix Dependencies & Update `requirements.txt`
      run: |
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip setuptools wheel
        pip install numpy scipy tensorflow keras scikit-learn pandas websocket-client grpcio protobuf python-dotenv || {
          echo "⚠️ Conflict detected! Fixing dependencies..."
          pip uninstall -y cbpro requests six
          pip install requests>=2.21.0 six>=1.12.0 tensorflow keras numpy scipy scikit-learn pandas websocket-client grpcio protobuf python-dotenv
          pip install --no-cache-dir git+https://github.com/danpaquin/coinbasepro-python.git
        }
        pip freeze | grep -v "pkg-resources" > requirements.txt  # ✅ Remove pkg-resources conflicts
        deactivate

    - name: 🛠 Build & Tag Docker Image
      run: |
        REPO_NAME=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        docker build --no-cache -t coinfx-trading-bot:latest .
        docker tag coinfx-trading-bot:latest ghcr.io/$REPO_NAME/coinfx-trading-bot:latest

    - name: 🧪 Run Docker Sanity Check
      run: docker run --rm coinfx-trading-bot:latest python -c "print('✅ Docker Sanity Check Passed')"

    - name: 🔑 Login to GitHub Container Registry (GHCR)
      run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: 📤 Push Docker Image to GHCR
      run: |
        REPO_NAME=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        docker push ghcr.io/$REPO_NAME/coinfx-trading-bot:latest

    - name: 🚀 Create `fxcbot` Executable
      run: |
        echo '#!/bin/bash' | sudo tee /usr/local/bin/fxcbot
        echo 'docker run --rm -it -e DISPLAY=$DISPLAY -v /tmp/.X11-unix:/tmp/.X11-unix --name coinfx-trading-bot ghcr.io/${{ github.repository_owner }}/coinfx-trading-bot:latest "$@"' | sudo tee -a /usr/local/bin/fxcbot
        sudo chmod +x /usr/local/bin/fxcbot

    - name: 📤 Upload `fxcbot` Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fxcbot-linux
        path: /usr/local/bin/fxcbot
