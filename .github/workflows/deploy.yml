name: CoinFx Bot Docker 🚀 (Self-fixing)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: 🐋 Setup Docker
      uses: docker/setup-buildx-action@v3

    - name: 🐍 Auto-fix Dependencies & Update requirements.txt
      run: |
        python -m venv venv && source venv/bin/activate
        pip install --upgrade pip
        pip install numpy scipy tensorflow keras scikit-learn pandas websocket-client grpcio protobuf cbpro requests python-dotenv || {
          echo "Conflict detected. Automatically correcting cbpro dependency:"
          pip uninstall -y cbpro requests
          pip install requests tensorflow keras numpy scipy scikit-learn pandas websocket-client grpcio protobuf python-dotenv
          pip install git+https://github.com/danpaquin/coinbasepro-python.git
        }
        pip freeze > requirements.txt
        deactivate

    - name: 🐋 Build Docker Image
      run: |
        docker build -t coinfx-trading-bot:latest .

    - name: 🧪 Sanity Check Docker Image
      run: |
        docker run --rm coinfx-trading-bot:latest python -c "print('✅ Docker Sanity Check Passed')"

    - name: 🚀 Create fxcbot Executable
      run: |
        echo '#!/bin/bash
        docker run --rm coinfx-trading-bot:latest "$@"' | sudo tee /usr/local/bin/fxcbot
        sudo chmod +x /usr/local/bin/fxcbot

    - name: 📤 Upload Executable Artifact
      uses: actions/upload-artifact@v4
      with:
        name: fxcbot-linux
        path: /usr/local/bin/fxcbot
