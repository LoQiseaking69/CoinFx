name: 🚀 Deploy CoinFx Trading Bot with Docker

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 🛠️ Checkout Repository
        uses: actions/checkout@v4

      - name: 🐳 Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: 🏷️ Log in to Docker Hub (Optional - if you have a registry)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 🐋 Build and Tag Docker Image
        run: |
          docker build -t coinfx-trading-bot:${{ github.sha }} -t coinfx-trading-bot:latest .

      - name: 🧪 Run Basic Sanity Test
        run: |
          docker run --rm coinfx-trading-bot:latest --help || (echo "Sanity check failed!" && exit 1)

      - name: 🚢 Push Docker Image to Docker Hub (Optional)
        run: |
          docker push coinfx-trading-bot:${{ github.sha }}
          docker push coinfx-trading-bot:latest

      - name: 📦 Create Executable Wrapper
        run: |
          sudo tee /usr/local/bin/fxcbot > /dev/null <<EOF
          #!/bin/bash
          docker run --rm -it --name coinfx-trading-bot coinfx-trading-bot:latest "\$@"
          EOF
          sudo chmod +x /usr/local/bin/fxcbot

      - name: ✅ Verify fxcbot Installation
        run: |
          command -v fxcbot
          fxcbot --help && echo "🚀 Bot is installed and verified successfully!"

      - name: 📤 Upload Executable Artifact
        uses: actions/upload-artifact@v4
        with:
          name: fxcbot-linux
          path: /usr/local/bin/fxcbot
